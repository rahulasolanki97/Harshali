<script>
    let balance = 0;
    let transactions = [];

    // Load data from localStorage on startup
    function loadData() {
        try {
            const dataString = localStorage.getItem('expense-data');
            if (dataString) {
                const data = JSON.parse(dataString);
                balance = data.balance || 0;
                transactions = data.transactions || [];
                
                // Convert timestamp strings back to Date objects
                transactions = transactions.map(t => ({
                    ...t,
                    timestamp: new Date(t.timestamp)
                }));
                console.log('Data loaded successfully!');
            }
        } catch (error) {
            console.log('No previous data found or parse error, starting fresh');
            balance = 0;
            transactions = [];
        }
        
        updateBalance();
        calculateSummaries();
        renderTransactions();
    }

    // Save data to localStorage
    function saveData() {
        try {
            const data = {
                balance: balance,
                transactions: transactions.map(t => ({
                    ...t,
                    timestamp: t.timestamp.toISOString() // Convert Date back to string for storage
                }))
            };
            localStorage.setItem('expense-data', JSON.stringify(data));
            console.log('Data saved successfully!');
        } catch (error) {
            console.error('Failed to save data:', error);
            alert('Failed to save data. Please try again.');
        }
    }

    function updateBalance() {
        document.getElementById('balance').textContent = '₹' + balance.toFixed(2);
    }

    function calculateSummaries() {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
        const yearAgo = new Date(today.getTime() - 365 * 24 * 60 * 60 * 1000);

        let dailyIncome = 0, dailyExpense = 0;
        let weeklyIncome = 0, weeklyExpense = 0;
        let monthlyIncome = 0, monthlyExpense = 0;
        let yearlyIncome = 0, yearlyExpense = 0;

        transactions.forEach((t) => {
            const transactionDate = new Date(t.timestamp);
            // Daily
            if (transactionDate >= today) {
                if (t.type === 'income') dailyIncome += t.amount;
                else dailyExpense += t.amount;
            }
            // Weekly
            if (transactionDate >= weekAgo) {
                if (t.type === 'income') weeklyIncome += t.amount;
                else weeklyExpense += t.amount;
            }
            // Monthly
            if (transactionDate >= monthAgo) {
                if (t.type === 'income') monthlyIncome += t.amount;
                else monthlyExpense += t.amount;
            }
            // Yearly
            if (transactionDate >= yearAgo) {
                if (t.type === 'income') yearlyIncome += t.amount;
                else yearlyExpense += t.amount;
            }
        });

        // Update daily
        document.getElementById('dailyIncome').textContent = '₹' + dailyIncome.toFixed(2);
        document.getElementById('dailyExpense').textContent = '₹' + dailyExpense.toFixed(2);
        document.getElementById('dailyNet').textContent = '₹' + (dailyIncome - dailyExpense).toFixed(2);

        // Update weekly
        document.getElementById('weeklyIncome').textContent = '₹' + weeklyIncome.toFixed(2);
        document.getElementById('weeklyExpense').textContent = '₹' + weeklyExpense.toFixed(2);
        document.getElementById('weeklyNet').textContent = '₹' + (weeklyIncome - weeklyExpense).toFixed(2);

        // Update monthly
        document.getElementById('monthlyIncome').textContent = '₹' + monthlyIncome.toFixed(2);
        document.getElementById('monthlyExpense').textContent = '₹' + monthlyExpense.toFixed(2);
        document.getElementById('monthlyNet').textContent = '₹' + (monthlyIncome - monthlyExpense).toFixed(2);

        // Update yearly
        document.getElementById('yearlyIncome').textContent = '₹' + yearlyIncome.toFixed(2);
        document.getElementById('yearlyExpense').textContent = '₹' + yearlyExpense.toFixed(2);
        document.getElementById('yearlyNet').textContent = '₹' + (yearlyIncome - yearlyExpense).toFixed(2);
    }

    function addMoney() {
        const description = document.getElementById('description').value;
        const amount = parseFloat(document.getElementById('amount').value);

        if (!description || !amount || amount <= 0) {
            alert('Please enter a valid description and amount');
            return;
        }

        balance += amount;
        transactions.push({
            id: Date.now(),
            type: 'income',
            description: description,
            amount: amount,
            category: 'Income',
            date: new Date().toLocaleDateString('en-IN'),
            timestamp: new Date(),
        });

        updateBalance();
        calculateSummaries();
        renderTransactions();
        clearInputs();
        saveData();
    }

    function addExpense() {
        const description = document.getElementById('description').value;
        const amount = parseFloat(document.getElementById('amount').value);
        const category = document.getElementById('category').value;

        if (!description || !amount || amount <= 0) {
            alert('Please enter a valid description and amount');
            return;
        }

        balance -= amount;
        transactions.push({
            id: Date.now(),
            type: 'expense',
            description: description,
            amount: amount,
            category: category,
            date: new Date().toLocaleDateString('en-IN'),
            timestamp: new Date(),
        });

        updateBalance();
        calculateSummaries();
        renderTransactions();
        clearInputs();
        saveData();
    }

    function deleteTransaction(id) {
        const transaction = transactions.find((t) => t.id === id);
        if (transaction) {
            if (transaction.type === 'income') {
                balance -= transaction.amount;
            } else {
                balance += transaction.amount;
            }
            transactions = transactions.filter((t) => t.id !== id);
            updateBalance();
            calculateSummaries();
            renderTransactions();
            saveData();
        }
    }

    function renderTransactions() {
        const listElement = document.getElementById('transactionList');
        if (transactions.length === 0) {
            listElement.innerHTML = '<div class="empty-state">No transactions yet. Start adding money or expenses!</div>';
            return;
        }

        listElement.innerHTML = transactions
            .map((t) => `
                <div class="transaction-item ${t.type}">
                    <div class="transaction-details">
                        <div class="transaction-description">${t.description}</div>
                        <div class="transaction-category">${t.category}</div>
                        <div class="transaction-date">${t.date}</div>
                    </div>
                    <div class="transaction-amount ${t.type}">
                        ${t.type === 'income' ? '+' : '-'}₹${t.amount.toFixed(2)}
                    </div>
                    <button class="delete-btn" onclick="deleteTransaction(${t.id})">Delete</button>
                </div>
            `)
            .reverse()
            .join('');
    }

    function clearInputs() {
        document.getElementById('description').value = '';
        document.getElementById('amount').value = '';
        document.getElementById('category').selectedIndex = 0;
    }

    // Load data when page loads
    window.addEventListener('DOMContentLoaded', loadData);
</script>
