import React, { useState, useEffect } from 'react';

export default function ExpenseTracker() {
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [showSignup, setShowSignup] = useState(false);
  const [showForgotPassword, setShowForgotPassword] = useState(false);
  const [currentUser, setCurrentUser] = useState(null);
  const [users, setUsers] = useState({});
  const [userData, setUserData] = useState({ transactions: [], balance: 0 });
  const [authError, setAuthError] = useState('');
  const [authSuccess, setAuthSuccess] = useState('');
  const [statusMessage, setStatusMessage] = useState('');
  const [isLoading, setIsLoading] = useState(true);
  
  // Form states
  const [description, setDescription] = useState('');
  const [amount, setAmount] = useState('');
  const [category, setCategory] = useState('Food');

  // Load data from persistent storage on mount
  useEffect(() => {
    loadAllData();
  }, []);
  
  // Auto-refresh data every 3 seconds when logged in
  useEffect(() => {
    if (isLoggedIn && currentUser) {
      const interval = setInterval(() => {
        refreshUserData();
      }, 3000);
      
      return () => clearInterval(interval);
    }
  }, [isLoggedIn, currentUser]);

  // Load all data from storage
  const loadAllData = async () => {
    try {
      setIsLoading(true);
      
      // Load users data with shared=true for cross-device access
      const usersResult = await window.storage.get('expense_tracker_users', true);
      if (usersResult && usersResult.value) {
        const loadedUsers = JSON.parse(usersResult.value);
        setUsers(loadedUsers);
      }
      
      // Check if there's a logged-in user (personal storage)
      const currentUserResult = await window.storage.get('expense_tracker_current_user');
      if (currentUserResult && currentUserResult.value) {
        const username = currentUserResult.value;
        
        // Load user's data with shared=true for cross-device access
        const userDataResult = await window.storage.get(`expense_tracker_data_${username}`, true);
        if (userDataResult && userDataResult.value) {
          const loadedUserData = JSON.parse(userDataResult.value);
          setCurrentUser(username);
          setUserData(loadedUserData);
          setIsLoggedIn(true);
        }
      }
    } catch (error) {
      console.error('Error loading data:', error);
    } finally {
      setIsLoading(false);
    }
  };

  // Refresh user data (for syncing across devices)
  const refreshUserData = async () => {
    if (!currentUser) return;
    
    try {
      const userDataResult = await window.storage.get(`expense_tracker_data_${currentUser}`, true);
      if (userDataResult && userDataResult.value) {
        const loadedUserData = JSON.parse(userDataResult.value);
        setUserData(loadedUserData);
      }
    } catch (error) {
      console.error('Error refreshing data:', error);
    }
  };

  // Save users to storage
  const saveUsers = async (updatedUsers) => {
    try {
      await window.storage.set('expense_tracker_users', JSON.stringify(updatedUsers), true);
      setUsers(updatedUsers);
    } catch (error) {
      console.error('Error saving users:', error);
      showStatus('Error saving users data', true);
    }
  };

  // Save current user to storage
  const saveCurrentUser = async (username) => {
    try {
      if (username) {
        await window.storage.set('expense_tracker_current_user', username);
      } else {
        await window.storage.delete('expense_tracker_current_user');
      }
    } catch (error) {
      console.error('Error saving current user:', error);
    }
  };

  // Save user data to storage
  const saveUserDataToStorage = async (username, data) => {
    try {
      await window.storage.set(`expense_tracker_data_${username}`, JSON.stringify(data), true);
      showStatus('Data saved successfully!');
    } catch (error) {
      console.error('Error saving user data:', error);
      showStatus('Error saving data', true);
    }
  };

  // Show status message
  const showStatus = (message, isError = false) => {
    setStatusMessage({ text: message, isError });
    setTimeout(() => setStatusMessage(''), 3000);
  };

  // Validate email
  const isValidEmail = (email) => {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  };

  // Signup
  const handleSignup = async () => {
    const username = document.getElementById('signupUsername').value.trim();
    const email = document.getElementById('signupEmail').value.trim();
    const password = document.getElementById('signupPassword').value;
    const confirmPassword = document.getElementById('signupPasswordConfirm').value;

    if (!username || !email || !password) {
      setAuthError('Please fill in all fields');
      return;
    }

    if (username.length < 3) {
      setAuthError('Username must be at least 3 characters');
      return;
    }

    if (!isValidEmail(email)) {
      setAuthError('Please enter a valid email address');
      return;
    }

    if (password.length < 6) {
      setAuthError('Password must be at least 6 characters');
      return;
    }

    if (password !== confirmPassword) {
      setAuthError('Passwords do not match');
      return;
    }

    // Check if username or email already exists
    if (users[username]) {
      setAuthError('Username already exists');
      return;
    }

    const emailExists = Object.values(users).some(user => user.email === email);
    if (emailExists) {
      setAuthError('Email already registered');
      return;
    }

    const newUsers = {
      ...users,
      [username]: {
        email: email,
        password: password,
        createdAt: new Date().toISOString()
      }
    };

    await saveUsers(newUsers);
    
    // Initialize empty user data
    const initialData = { transactions: [], balance: 0 };
    await saveUserDataToStorage(username, initialData);
    
    setAuthSuccess('Account created successfully! You can now login.');
    setAuthError('');
    
    // Clear form
    document.getElementById('signupUsername').value = '';
    document.getElementById('signupEmail').value = '';
    document.getElementById('signupPassword').value = '';
    document.getElementById('signupPasswordConfirm').value = '';
    
    setTimeout(() => {
      setShowSignup(false);
      setAuthSuccess('');
    }, 2000);
  };

  // Login
  const handleLogin = async () => {
    const loginInput = document.getElementById('loginInput').value.trim();
    const password = document.getElementById('loginPassword').value;

    if (!loginInput || !password) {
      setAuthError('Please enter username/email and password');
      return;
    }

    // Find user by username or email
    let username = null;
    let user = null;

    // Check if input is email or username
    if (isValidEmail(loginInput)) {
      // Search by email
      for (const [uname, udata] of Object.entries(users)) {
        if (udata.email === loginInput) {
          username = uname;
          user = udata;
          break;
        }
      }
    } else {
      // Search by username
      username = loginInput;
      user = users[username];
    }

    if (!user || user.password !== password) {
      setAuthError('Invalid username/email or password');
      return;
    }

    // Load user data
    try {
      const userDataResult = await window.storage.get(`expense_tracker_data_${username}`, true);
      let loadedData = { transactions: [], balance: 0 };
      
      if (userDataResult && userDataResult.value) {
        loadedData = JSON.parse(userDataResult.value);
      } else {
        // Initialize if no data exists
        await saveUserDataToStorage(username, loadedData);
      }

      setCurrentUser(username);
      setUserData(loadedData);
      setIsLoggedIn(true);
      setAuthError('');
      
      // Save current user session
      await saveCurrentUser(username);
      
      showStatus(`Welcome back, ${username}!`);
      
      // Clear form
      document.getElementById('loginInput').value = '';
      document.getElementById('loginPassword').value = '';
    } catch (error) {
      setAuthError('Error loading user data');
      console.error('Login error:', error);
    }
  };

  // Forgot Password
  const handleForgotPassword = async () => {
    const emailInput = document.getElementById('forgotEmail').value.trim();

    if (!emailInput) {
      setAuthError('Please enter your email address');
      return;
    }

    if (!isValidEmail(emailInput)) {
      setAuthError('Please enter a valid email address');
      return;
    }

    // Find user by email
    let foundUsername = null;
    for (const [username, userData] of Object.entries(users)) {
      if (userData.email === emailInput) {
        foundUsername = username;
        break;
      }
    }

    if (!foundUsername) {
      setAuthError('No account found with this email address');
      return;
    }

    // Show password (in a real app, you'd send an email)
    const userPassword = users[foundUsername].password;
    setAuthSuccess(`Your password is: ${userPassword}\n\nUsername: ${foundUsername}\n\nPlease save this information and login.`);
    setAuthError('');
    
    setTimeout(() => {
      setShowForgotPassword(false);
      setAuthSuccess('');
      document.getElementById('forgotEmail').value = '';
    }, 8000);
  };

  // Logout
  const handleLogout = async () => {
    if (window.confirm('Are you sure you want to logout?')) {
      await saveCurrentUser(null);
      setIsLoggedIn(false);
      setCurrentUser(null);
      setUserData({ transactions: [], balance: 0 });
      setShowSignup(false);
      setShowForgotPassword(false);
    }
  };

  // Save user data
  const saveUserData = async (newTransactions, newBalance) => {
    if (!currentUser) return;
    
    const newData = { transactions: newTransactions, balance: newBalance };
    setUserData(newData);
    await saveUserDataToStorage(currentUser, newData);
  };

  // Add transaction
  const addTransaction = (type) => {
    if (!description || !amount || parseFloat(amount) <= 0) {
      alert('Please enter valid description and amount!');
      return;
    }

    const transaction = {
      id: Date.now(),
      type: type,
      description: description,
      amount: parseFloat(amount),
      category: category,
      date: new Date().toISOString()
    };

    const newTransactions = [transaction, ...userData.transactions];
    const newBalance = type === 'income' 
      ? userData.balance + parseFloat(amount)
      : userData.balance - parseFloat(amount);

    saveUserData(newTransactions, newBalance);
    setDescription('');
    setAmount('');
  };

  // Delete transaction
  const deleteTransaction = (id) => {
    const transaction = userData.transactions.find(t => t.id === id);
    if (!transaction) return;

    const newBalance = transaction.type === 'income'
      ? userData.balance - transaction.amount
      : userData.balance + transaction.amount;

    const newTransactions = userData.transactions.filter(t => t.id !== id);
    saveUserData(newTransactions, newBalance);
  };

  // Calculate summaries
  const calculateSummaries = () => {
    const now = new Date();
    const periods = {
      daily: 1,
      weekly: 7,
      monthly: 30,
      yearly: 365
    };

    const summaries = {};

    Object.keys(periods).forEach(period => {
      const days = periods[period];
      const cutoffDate = new Date(now.getTime() - (days * 24 * 60 * 60 * 1000));
      
      let income = 0;
      let expense = 0;

      userData.transactions.forEach(t => {
        const tDate = new Date(t.date);
        if (tDate >= cutoffDate) {
          if (t.type === 'income') {
            income += t.amount;
          } else {
            expense += t.amount;
          }
        }
      });

      summaries[period] = {
        income,
        expense,
        net: income - expense
      };
    });

    return summaries;
  };

  const summaries = calculateSummaries();

  // Loading screen
  if (isLoading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-indigo-600 to-purple-700 flex items-center justify-center">
        <div className="bg-white rounded-2xl shadow-2xl p-8 text-center">
          <div className="text-6xl mb-4">ðŸ’°</div>
          <div className="text-xl font-bold text-gray-800">Loading...</div>
        </div>
      </div>
    );
  }

  if (!isLoggedIn) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-indigo-600 to-purple-700 flex items-center justify-center p-4">
        {statusMessage && (
          <div className={`fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 ${
            statusMessage.isError ? 'bg-red-500' : 'bg-green-500'
          } text-white`}>
            {statusMessage.text}
          </div>
        )}
        
        <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
          <div className="text-center mb-8">
            <div className="text-6xl mb-4">ðŸ’°</div>
            <h1 className="text-3xl font-bold text-gray-800 mb-2">Expense Tracker</h1>
            <p className="text-gray-600">Track your finances securely</p>
          </div>

          {authError && (
            <div className="bg-red-50 border-l-4 border-red-500 text-red-700 p-3 rounded mb-4 text-sm">
              {authError}
            </div>
          )}

          {authSuccess && (
            <div className="bg-green-50 border-l-4 border-green-500 text-green-700 p-3 rounded mb-4 text-sm whitespace-pre-line">
              {authSuccess}
            </div>
          )}

          {/* Login Form */}
          {!showSignup && !showForgotPassword && (
            <div>
              <div className="mb-4">
                <label className="block text-gray-700 font-medium mb-2">Username or Email</label>
                <input
                  type="text"
                  id="loginInput"
                  placeholder="Enter your username or email"
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                  onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                />
              </div>
              <div className="mb-4">
                <label className="block text-gray-700 font-medium mb-2">Password</label>
                <input
                  type="password"
                  id="loginPassword"
                  placeholder="Enter your password"
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                  onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                />
              </div>
              <div className="mb-6 text-right">
                <button
                  onClick={() => { setShowForgotPassword(true); setAuthError(''); setAuthSuccess(''); }}
                  className="text-blue-600 text-sm hover:underline"
                >
                  Forgot Password?
                </button>
              </div>
              <button
                onClick={handleLogin}
                className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition mb-4"
              >
                Login
              </button>
              <div className="text-center text-gray-600">
                Don't have an account?{' '}
                <button
                  onClick={() => { setShowSignup(true); setAuthError(''); setAuthSuccess(''); }}
                  className="text-blue-600 font-bold hover:underline"
                >
                  Sign Up
                </button>
              </div>
            </div>
          )}

          {/* Signup Form */}
          {showSignup && !showForgotPassword && (
            <div>
              <div className="mb-4">
                <label className="block text-gray-700 font-medium mb-2">Username</label>
                <input
                  type="text"
                  id="signupUsername"
                  placeholder="Choose a username"
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                />
              </div>
              <div className="mb-4">
                <label className="block text-gray-700 font-medium mb-2">Email</label>
                <input
                  type="email"
                  id="signupEmail"
                  placeholder="Enter your email"
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                />
              </div>
              <div className="mb-4">
                <label className="block text-gray-700 font-medium mb-2">Password</label>
                <input
                  type="password"
                  id="signupPassword"
                  placeholder="Choose a password (min 6 characters)"
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                />
              </div>
              <div className="mb-6">
                <label className="block text-gray-700 font-medium mb-2">Confirm Password</label>
                <input
                  type="password"
                  id="signupPasswordConfirm"
                  placeholder="Confirm your password"
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                />
              </div>
              <button
                onClick={handleSignup}
                className="w-full bg-yellow-400 text-gray-900 py-3 rounded-lg font-bold hover:bg-yellow-500 transition mb-4"
              >
                Sign Up
              </button>
              <div className="text-center text-gray-600">
                Already have an account?{' '}
                <button
                  onClick={() => { setShowSignup(false); setAuthError(''); setAuthSuccess(''); }}
                  className="text-blue-600 font-bold hover:underline"
                >
                  Login
                </button>
              </div>
            </div>
          )}

          {/* Forgot Password Form */}
          {showForgotPassword && (
            <div>
              <div className="mb-6">
                <h2 className="text-xl font-bold text-gray-800 mb-2">Forgot Password?</h2>
                <p className="text-sm text-gray-600 mb-4">Enter your email address and we'll help you recover your account.</p>
                <label className="block text-gray-700 font-medium mb-2">Email Address</label>
                <input
                  type="email"
                  id="forgotEmail"
                  placeholder="Enter your registered email"
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                  onKeyPress={(e) => e.key === 'Enter' && handleForgotPassword()}
                />
              </div>
              <button
                onClick={handleForgotPassword}
                className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition mb-4"
              >
                Recover Account
              </button>
              <div className="text-center text-gray-600">
                Remember your password?{' '}
                <button
                  onClick={() => { setShowForgotPassword(false); setAuthError(''); setAuthSuccess(''); }}
                  className="text-blue-600 font-bold hover:underline"
                >
                  Back to Login
                </button>
              </div>
            </div>
          )}
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-600 to-purple-700 p-4">
      {statusMessage && (
        <div className={`fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 ${
          statusMessage.isError ? 'bg-red-500' : 'bg-green-500'
        } text-white`}>
          {statusMessage.text}
        </div>
      )}

      <div className="max-w-6xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden">
        {/* Header */}
        <div className="bg-gradient-to-r from-yellow-400 to-yellow-500 p-6 relative">
          <h1 className="text-3xl font-bold text-gray-800 text-center">ðŸ’° Expense Tracker</h1>
          <p className="text-center text-gray-700">Manage your daily finances</p>
          <div className="absolute top-4 right-4 flex items-center gap-3">
            <span className="bg-white px-4 py-2 rounded-full font-bold text-gray-800">
              {currentUser}
            </span>
            <button
              onClick={handleLogout}
              className="bg-red-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-red-600 transition"
            >
              Logout
            </button>
          </div>
        </div>

        {/* Balance Display */}
        <div className="bg-blue-600 text-white p-8 text-center">
          <div className="text-lg mb-2">Current Balance</div>
          <div className="text-5xl font-bold">â‚¹{userData.balance.toFixed(2)}</div>
        </div>

        {/* Summary Cards */}
        <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-4 p-6 bg-gray-50">
          {Object.entries(summaries).map(([period, data]) => (
            <div key={period} className="bg-white rounded-xl p-4 shadow-md border-l-4 border-blue-500">
              <div className="text-lg font-semibold text-gray-700 mb-3 capitalize">
                {period === 'daily' && 'ðŸ“…'} {period === 'weekly' && 'ðŸ“Š'} 
                {period === 'monthly' && 'ðŸ“ˆ'} {period === 'yearly' && 'ðŸ“†'} {period}
              </div>
              <div className="space-y-2 text-sm">
                <div className="flex justify-between">
                  <span className="text-gray-600">Income:</span>
                  <span className="font-bold text-green-600">â‚¹{data.income.toFixed(2)}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-600">Expenses:</span>
                  <span className="font-bold text-red-600">â‚¹{data.expense.toFixed(2)}</span>
                </div>
                <div className="flex justify-between pt-2 border-t">
                  <span className="text-gray-600">Net:</span>
                  <span className="font-bold text-blue-600 text-lg">â‚¹{data.net.toFixed(2)}</span>
                </div>
              </div>
            </div>
          ))}
        </div>

        {/* Input Section */}
        <div className="p-6 bg-gray-50">
          <div className="flex flex-wrap gap-3 mb-4">
            <input
              type="text"
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              placeholder="Description"
              className="flex-1 min-w-[200px] px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
            />
            <input
              type="number"
              value={amount}
              onChange={(e) => setAmount(e.target.value)}
              placeholder="Amount"
              step="0.01"
              className="flex-1 min-w-[150px] px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
            />
            <select
              value={category}
              onChange={(e) => setCategory(e.target.value)}
              className="flex-1 min-w-[150px] px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
            >
              <option value="Food">Food</option>
              <option value="EMI">EMI</option>
              <option value="Online shopping">Online shopping</option>
              <option value="Donations">Donations</option>
              <option value="Fuel">Fuel</option>
              <option value="Cash expenses">Cash expenses</option>
              <option value="Recharges">Recharges</option>
              <option value="Transport">Transport</option>
              <option value="Shopping">Shopping</option>
              <option value="Bills">Bills</option>
              <option value="Entertainment">Entertainment</option>
              <option value="Health">Health</option>
              <option value="Salary">Salary</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div className="flex gap-3">
            <button
              onClick={() => addTransaction('income')}
              className="flex-1 bg-yellow-400 text-gray-900 py-3 rounded-lg font-bold hover:bg-yellow-500 transition"
            >
              ðŸ’° Add Money
            </button>
            <button
              onClick={() => addTransaction('expense')}
              className="flex-1 bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition"
            >
              ðŸ’¸ Add Expense
            </button>
          </div>
        </div>

        {/* Transactions List */}
        <div className="p-6">
          <h2 className="text-2xl font-bold text-gray-800 mb-4">Recent Transactions</h2>
          <div className="max-h-96 overflow-y-auto space-y-3">
            {userData.transactions.length === 0 ? (
              <div className="text-center py-12 text-gray-400">
                No transactions yet. Add your first transaction above!
              </div>
            ) : (
              userData.transactions.map((t) => (
                <div
                  key={t.id}
                  className={`flex items-center justify-between p-4 rounded-lg shadow-md border-l-4 ${
                    t.type === 'income'
                      ? 'bg-yellow-50 border-yellow-400'
                      : 'bg-red-50 border-red-400'
                  }`}
                >
                  <div className="flex-1">
                    <div className="font-bold text-gray-800">{t.description}</div>
                    <div className="text-sm text-gray-600">{t.category}</div>
                    <div className="text-xs text-gray-400">
                      {new Date(t.date).toLocaleString('en-IN')}
                    </div>
                  </div>
                  <div className="flex items-center gap-3">
                    <div className={`text-xl font-bold ${
                      t.type === 'income' ? 'text-green-600' : 'text-red-600'
                    }`}>
                      {t.type === 'income' ? '+' : '-'}â‚¹{t.amount.toFixed(2)}
                    </div>
                    <button
                      onClick={() => deleteTransaction(t.id)}
                      className="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition"
                    >
                      Delete
                    </button>
                  </div>
                </div>
              ))
            )}
          </div>
        </div>
      </div>
    </div>
  );
}
