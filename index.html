function doGet(e) {
  const action = e.parameter.action;
  
  // SIGNUP
  if (action === 'signup') {
    const username = e.parameter.username;
    const email = e.parameter.email;
    const password = e.parameter.password;
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Users');
    const data = sheet.getDataRange().getValues();
    
    // Check if username already exists
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === username) {
        return ContentService.createTextOutput(JSON.stringify({
          success: false,
          message: 'Username already exists'
        })).setMimeType(ContentService.MimeType.JSON);
      }
      if (data[i][1] === email) {
        return ContentService.createTextOutput(JSON.stringify({
          success: false,
          message: 'Email already registered'
        })).setMimeType(ContentService.MimeType.JSON);
      }
    }
    
    // Add new user (Username, Email, Password, ResetCode, Transactions)
    sheet.appendRow([username, email, password, '', '[]']);
    
    return ContentService.createTextOutput(JSON.stringify({
      success: true,
      message: 'Account created successfully! Please login.'
    })).setMimeType(ContentService.MimeType.JSON);
  }
  
  // LOGIN
  if (action === 'login') {
    const username = e.parameter.username;
    const password = e.parameter.password;
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Users');
    const data = sheet.getDataRange().getValues();
    
    for (let i = 1; i < data.length; i++) {
      // Check username or email
      if ((data[i][0] === username || data[i][1] === username) && data[i][2] === password) {
        const transactions = data[i][4] ? JSON.parse(data[i][4]) : [];
        let balance = 0;
        
        // Calculate balance
        transactions.forEach(t => {
          if (t.type === 'income') {
            balance += parseFloat(t.amount);
          } else {
            balance -= parseFloat(t.amount);
          }
        });
        
        return ContentService.createTextOutput(JSON.stringify({
          success: true,
          username: data[i][0],
          transactions: transactions,
          balance: balance
        })).setMimeType(ContentService.MimeType.JSON);
      }
    }
    
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: 'Invalid username or password'
    })).setMimeType(ContentService.MimeType.JSON);
  }
  
  // GET PASSWORD BY EMAIL (Forgot Password - Simple Version)
  if (action === 'getPassword') {
    const email = e.parameter.email;
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Users');
    const data = sheet.getDataRange().getValues();
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][1] === email) {
        const username = data[i][0];
        const password = data[i][2];
        
        return ContentService.createTextOutput(JSON.stringify({
          success: true,
          username: username,
          password: password
        })).setMimeType(ContentService.MimeType.JSON);
      }
    }
    
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: 'No account found with this email address'
    })).setMimeType(ContentService.MimeType.JSON);
  }
  
  // Default response
  return ContentService.createTextOutput(JSON.stringify({
    success: false,
    message: 'Invalid action'
  })).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  const data = JSON.parse(e.postData.contents);
  const action = data.action;
  
  // ADD TRANSACTION
  if (action === 'addTransaction') {
    const username = data.username;
    const transaction = JSON.parse(data.transaction);
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Users');
    const userData = sheet.getDataRange().getValues();
    
    for (let i = 1; i < userData.length; i++) {
      if (userData[i][0] === username) {
        let transactions = userData[i][4] ? JSON.parse(userData[i][4]) : [];
        transactions.push(transaction);
        
        // Update transactions in column E (index 4)
        sheet.getRange(i + 1, 5).setValue(JSON.stringify(transactions));
        
        // Calculate new balance
        let balance = 0;
        transactions.forEach(t => {
          if (t.type === 'income') {
            balance += parseFloat(t.amount);
          } else {
            balance -= parseFloat(t.amount);
          }
        });
        
        return ContentService.createTextOutput(JSON.stringify({
          success: true,
          transactions: transactions,
          balance: balance
        })).setMimeType(ContentService.MimeType.JSON);
      }
    }
  }
  
  // DELETE TRANSACTION
  if (action === 'deleteTransaction') {
    const username = data.username;
    const index = data.index;
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Users');
    const userData = sheet.getDataRange().getValues();
    
    for (let i = 1; i < userData.length; i++) {
      if (userData[i][0] === username) {
        let transactions = userData[i][4] ? JSON.parse(userData[i][4]) : [];
        transactions.splice(index, 1);
        
        // Update transactions
        sheet.getRange(i + 1, 5).setValue(JSON.stringify(transactions));
        
        // Calculate new balance
        let balance = 0;
        transactions.forEach(t => {
          if (t.type === 'income') {
            balance += parseFloat(t.amount);
          } else {
            balance -= parseFloat(t.amount);
          }
        });
        
        return ContentService.createTextOutput(JSON.stringify({
          success: true,
          transactions: transactions,
          balance: balance
        })).setMimeType(ContentService.MimeType.JSON);
      }
    }
  }
  
  return ContentService.createTextOutput(JSON.stringify({
    success: false,
    message: 'Invalid action'
  })).setMimeType(ContentService.MimeType.JSON);
}

// Optional: Clean up expired reset codes (run this on a timer trigger)
function cleanupExpiredCodes() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Users');
  const data = sheet.getDataRange().getValues();
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][3]) { // If reset code exists
      sheet.getRange(i + 1, 4).setValue(''); // Clear it
    }
  }
  
  Logger.log('Reset codes cleaned up');
}
